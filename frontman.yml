- hosts:
    - localhost
  no_log: true
  vars_files:
    - ./config/frontman.yml
    - ./config/servers.yml
    - ./config/supabase.yml
  pre_tasks:
    - name: Fetch configs UUIDs from Supabase
      delegate_to: localhost
      uri:
        url: "{{ config_supabase_project_url }}/rest/v1/configs?select=uuid"
        method: GET
        headers:
          apikey: "{{ config_supabase_secret_api_key }}"
          Authorization: "Bearer {{ config_supabase_secret_api_key }}"
      register: supabase_configs_response

    - name: Set user UUIDs fact
      delegate_to: localhost
      set_fact:
        config_local_configs: "{{ supabase_configs_response.json | map(attribute='uuid') | list }}"

    - name: Fetch users UUIDs from Supabase
      delegate_to: localhost
      uri:
        url: "{{ config_supabase_project_url }}/rest/v1/users?select=child_uuid"
        method: GET
        headers:
          apikey: "{{ config_supabase_secret_api_key }}"
          Authorization: "Bearer {{ config_supabase_secret_api_key }}"
      register: supabase_users_response

    - name: Set user UUIDs fact
      delegate_to: localhost
      set_fact:
        config_local_users: "{{ supabase_users_response.json | map(attribute='child_uuid') | list }}"
  roles:
    - role: frontman
      vars:
        frontman_default_redirect: "{{ config_frontman_default_redirect }}"
        frontman_servers: "{{ config_servers }}"
        frontman_configs: "{{ config_local_configs }}"
        frontman_users: "{{ config_local_users }}"
        frontman_static_directory_filename: static
        frontman_title: "{{ config_users_title }}"
        frontman_base_url: "{{ config_users_base_url }}"
        frontman_cloudflare_project_name: "{{ config_frontman_cloudflare_project_name }}"
        frontman_cloudflare_account_id: "{{ config_frontman_cloudflare_account_id }}"
        frontman_cloudflare_api_token: "{{ config_frontman_cloudflare_api_token }}"
